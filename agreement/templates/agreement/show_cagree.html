{% extends 'agreement/base.html' %}
	{% block title %}Show Created Agreements{% endblock %}
	{% block content %}
	<div class="box box-info">
            <div class="box-header with-border">
              	<h3 class="box-title">Created Agreements</h3>
              	<form action='{% url "type_search" %}' method='post'>{% csrf_token %}
					<label for="name">Search Agreement by Type</label>
					<div class="form-group">
						<input type="text" value={{agreement_type}} id='agreement_type' onchange="myFunction()">
						<input type="submit" name="Search Post" value="Search Agreement">
					</div>
			  	</form>
			  	<form action='{% url "date_search" %}' method='post'>{% csrf_token %}
			  		<label for="name">Search Agreement by Date</label>
			  		<div class="form-group">
			  			<label for="name">Start Date</label>
			  			<input type="date" name="sdate" id='sdate' value={{sdate}} onchange="_filter()">
			  			<label for="name">End Date</label>
			  			<input type="date" name="edate" id='edate' value={{edate}} onchange="_filter()">
			  			<input type="submit" name="Search Agreement" value="Search Agreement">
			  		</div>
			  	</form>

             </div>

             {% if messages %}
			    <ul class="messages">
			        {% for message in messages %}
			            <p>{{ message }}</p>
			        {% endfor %}
			    </ul>
			{% endif %}



             <div class="box-body">
             <div class="table-responsive">
				<table class="table no-margin" id="mytable">
					<thead>
						<tr>
							<th>Creation Date</th>
							<th>Agreement Type</th>
							<th>Name</th>
							<th>Email Id</th>
							<th>Status</th>
							<th>Actions</th>
							<th></th>
							<th>Preview</th>
						</tr>
					</thead>
					<tbody>
						{% if agreement_set %}
							{% for master_created_set in agreement_set %}
						<tr>
							<td>{{master_created_set.0}}</td>
							<td>{{master_created_set.1}}</td>
							<td>{{master_created_set.2}}</td>
							<td>{{master_created_set.3}}</td>
							<td>{{master_created_set.4}}</td>
							{% if master_created_set.4 != 'signed' %}
							<td><a href="{% url 'terminate' master_created_set.5 %}" style="color: red">Terminate</a></td> 
							<td><a href="url 'withdraw' master_created_set.5 ">Withdraw</a></td>
							{% else %}
							<td></td>
							<td></td>
							{% endif %}
							<td><a id="preview_{{forloop.counter}}" data-toggle="modal" href="#mymodal" data-id={{master_created_set.5}} >Preview</a></td>
							

							
			<div id= "mymodal" class="modal"  role="dialog">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title">Preview Document</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body">
			      	<p id='document'></p>
			      </div>
			      <div class="modal-footer">
			        <a id="sendbutton" class="button" href=""> Send  </a> 
			        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			      </div>
			    </div>
			  </div>
			</div>
				<td>{% if master_created_set.8 %}
					<a href="{% url 'generatepdf' master_created_set.5 %}">Download</a>
					{% endif %}
					 </td>
							</td>
						</tr>
							{% endfor %}
						{% else %}
							<td>No data to show </td>
						{% endif %}
					</tbody>
				</table>	
			</div>
			<!-- Get agreement text in preview modal-->
			<script type="text/javascript">
				$(document).ready(function(){
					var input, filter, table, tr, td, i;
                          input = document.getElementById("agreement_type");
                          filter=input.value.toUpperCase();
                          table = document.getElementById("myTable");
                          tr = table.getElementsByTagName("tr");
                          for (i = 0; i < tr.length; i++) {
                            td = tr[i].getElementsByTagName("td")[1];
                            console.log(td);
                            if (td) {
                              if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                                tr[i].style.display = "";
                              } else {
                                tr[i].style.display = "none";
                              }
                            }       
                          }
                        
				});
				$("a").on('click', function (event) {
			      				// var c_document=""
			      				var c_id= $(this).data('id');
			      				console.log(c_id);
			      				console.log({{created_doclist|safe}});
			      				var obj={{created_doclist|safe}}

                        for(var item in obj)
                        {
                        	for(i=0;i<obj.length;i++)
                        	{
	                            console.log(obj[i].id);
	                            if(obj[i].id==c_id)
	                            {
	                            	$('#document').html(obj[i].document);
	                            	if(obj[i].key=="")
	                            	{
	                            		alert("Agreement has already been signed");
	                            	}
	                            	else
	                            	{
	                            		$("#sendbutton").attr("href", "verify/"+obj[i].key);
	                            	}
	                            }
	                        }
						}

			      			});
			      				
			      		
                        function myFunction() {
                          var input, filter, table, tr, td, i;
                          input = documet.getElementById("agreement_type");
                          filter = input.value.toUpperCase();
                          console.log(filter);
                          table = document.getElementById("myTable");
                          tr = table.getElementsByTagName("tr");
                          for (i = 0; i < tr.length; i++) {
                            td = tr[i].getElementsByTagName("td")[1];
                            console.log(td);
                            if (td) {
                              if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
                                tr[i].style.display = "";
                              } else {
                                tr[i].style.display = "none";
                              }
                            }       
                          }
                        }

                        function _filter() {
                            input = document.getElementById("myinput");
                          filter = input.value.toUpperCase();
                          console.log(filter);
                              var dateFrom = new Date(document.getElementById('sdate').value);
                              var dateTo = new Date(document.getElementById('edate').value);
                              table = document.getElementById("myTable");
                               var tr = table.getElementsByTagName("tr");
                              for (i = 0; i < tr.length; i++) 
                                {   
                                    id = tr[i].getElementsByTagName("td")[1];
                                    td = tr[i].getElementsByTagName("td")[0];
                                    if(filter==1)
                                    { console.log("1");
                                        if (td) 
                                        {console.log("2");
                                            var date=new Date(td.innerHTML);
                                               console.log(date);
                                                    if(date>=dateFrom && date<=dateTo)
                                                    {
                                                        console.log("3");
                                                        tr[i].style.display = "";
                                                    }
                                                    else
                                                    {
                                                        console.log("4");
                                                        tr[i].style.display = "none";
                                                    }
                                        }
                                    }
                                    else
                                    {    console.log("5"); 
                                        if (td)
                                        {
                                            console.log("6");
                                            if(id)
                                            {
                                                console.log("7");
                                                var date=new Date(td.innerHTML);
                                                console.log(date);
                                                    if(date>=dateFrom && date<=dateTo && (id.innerHTML.toUpperCase().indexOf(filter) > -1))
                                                    {
                                                        console.log("8");
                                                        tr[i].style.display = "";
                                                    }
                                                    else
                                                    {
                                                        tr[i].style.display = "none";
                                                    }
                                            }
                                        }
                                    }
                                }
                                                 
                            }
                              
                    		
						</script>
			<div class="dataTables_paginate paging_simple_numbers" id="example2_paginate">
	              <ul class="pagination">
	                 {% if agreement_set.has_previous %}
	                <li class="paginate_button previous" id="example2_previous"><a href="?page={{ agreement_set.previous_page_number }}" aria-controls="example2" data-dt-idx="0" tabindex="0">Previous</a></li>
	                {% endif %}
	                <li class="paginate_button "><a href="?page=1" aria-controls="example2" data-dt-idx="1" tabindex="0">1</a></li>
	                <li class="paginate_button "><a href="?page=2" aria-controls="example2" data-dt-idx="5" tabindex="0">2</a></li>
	                {% if agreement_set.has_next %}
	                <li class="paginate_button "><a href="?page={{ agreement_set.next_page_number }}" aria-controls="example2" data-dt-idx="5" tabindex="0">Next</a></li>
	                <li class="paginate_button "><a href="?page={{ agreement_set.paginator.num_pages }}" aria-controls="example2" data-dt-idx="5" tabindex="0">Last</a></li>
	                {% endif %}
	              </ul>
            </div>  



		</div>
			
    </div>
{% endblock %}
	